<!DOCTYPE html>
<html>

<head>
    <title>Depth Demo</title>
</head>

<body>
    <input type="file" accept="image/*">
    <div>
        <img id="input">
        <canvas id="output"></canvas>
    </div>
    <div id="status"></div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.4.2/dist/transformers.min.js';

        const status = document.getElementById('status');
        const input = document.getElementById('input');
        const output = document.getElementById('output');

        // Load model
        status.textContent = 'Loading model...';
        const depth = await pipeline('depth-estimation', 'onnx-community/depth-anything-v2-base', {
            device: 'webgpu',
        });
        status.textContent = 'Ready';

        // Handle file selection
        document.querySelector('input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Load image
            const url = URL.createObjectURL(file);
            input.src = url;

            // Wait for image to load
            await new Promise(r => input.onload = r);

            try {
                // Run depth estimation
                status.textContent = 'Processing...';
                const result = await depth(url);

                // Display depth map
                output.width = result.depth.width;
                output.height = result.depth.height;
                const ctx = output.getContext('2d');
                const imageData = ctx.createImageData(output.width, output.height);

                for (let i = 0; i < result.depth.data.length; i++) {
                    const v = result.depth.data[i];
                    imageData.data[i * 4] = v;
                    imageData.data[i * 4 + 1] = v;
                    imageData.data[i * 4 + 2] = v;
                    imageData.data[i * 4 + 3] = 255;
                }

                ctx.putImageData(imageData, 0, 0);
                status.textContent = 'Done';

                // Clean up
                URL.revokeObjectURL(url);
            } catch (error) {
                status.textContent = 'Error: ' + error;
                console.error(error);
            }
        };
    </script>
</body>

</html>